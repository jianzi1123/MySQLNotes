### ç¬¬09ç«  æ€§èƒ½åˆ†æå·¥å…·çš„ä½¿ç”¨

åœ¨æ•°æ®åº“è°ƒä¼˜ä¸­ï¼Œæˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯  `å“åº”æ—¶é—´æ›´å¿«ï¼Œååé‡æ›´å¤§`ã€‚åˆ©ç”¨å®è§‚çš„ç›‘æ§å·¥å…·å’Œå¾®è§‚çš„æ—¥å¿—åˆ†æå¯ä»¥å¸®æˆ‘ä»¬å¿«é€Ÿæ‰¾åˆ°è°ƒä¼˜çš„æ€è·¯å’Œæ–¹å¼ 

#### 1.æ•°æ®åº“æœåŠ¡å™¨çš„ä¼˜åŒ–æ­¥éª¤

å½“æˆ‘ä»¬é‡åˆ°[æ•°æ®åº“è°ƒä¼˜](https://so.csdn.net/so/search?q=æ•°æ®åº“è°ƒä¼˜&spm=1001.2101.3001.7020)é—®é¢˜çš„æ—¶å€™ï¼Œè¯¥å¦‚ä½•æ€è€ƒå‘¢ï¼Ÿè¿™é‡ŒæŠŠæ€è€ƒçš„æµç¨‹æ•´ç†æˆä¸‹é¢è¿™å¼ å›¾ã€‚

æ•´ä¸ªæµç¨‹åˆ’åˆ†æˆäº†` è§‚å¯Ÿï¼ˆShow statusï¼‰` å’Œ `è¡ŒåŠ¨ï¼ˆActionï¼‰` ä¸¤ä¸ªéƒ¨åˆ†ã€‚å­—æ¯ S çš„éƒ¨åˆ†ä»£è¡¨è§‚å¯Ÿï¼ˆä¼šä½¿ç”¨ç›¸åº”çš„åˆ†æå·¥å…·ï¼‰ï¼Œå­—æ¯ A ä»£è¡¨çš„éƒ¨åˆ†æ˜¯è¡ŒåŠ¨ï¼ˆå¯¹åº”åˆ†æå¯ä»¥é‡‡å–çš„è¡ŒåŠ¨

![1771d1ef972c4fbd946c55b1fb52d0e7](./%E7%AC%AC09%E7%AB%A0%20%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8.assets/1771d1ef972c4fbd946c55b1fb52d0e7.png)

![618f6a951d8e45473f8c5dc91185180f](./%E7%AC%AC09%E7%AB%A0%20%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8.assets/618f6a951d8e45473f8c5dc91185180f.png)

![2344459cacd61a3a4d7f4aef4a3c9b69](./%E7%AC%AC09%E7%AB%A0%20%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8.assets/2344459cacd61a3a4d7f4aef4a3c9b69.png)

å¯ä»¥çœ‹åˆ°æ•°æ®åº“è°ƒä¼˜çš„æ­¥éª¤ä¸­è¶Šå¾€é‡‘å­—å¡”å°–èµ°ï¼Œå…¶æˆæœ¬è¶Šé«˜ï¼Œæ•ˆæœè¶Šå·®ï¼Œå› æ­¤æˆ‘ä»¬åœ¨æ•°æ®åº“è°ƒä¼˜çš„è¿‡ç¨‹ä¸­ï¼Œè¦é‡ç‚¹æŠŠæ¡é‡‘å­—å¡”åº•éƒ¨çš„ sql åŠç´¢å¼•è°ƒä¼˜ï¼Œæ•°æ®åº“è¡¨ç»“æ„è°ƒä¼˜ï¼Œç³»ç»Ÿé…ç½®å‚æ•°è°ƒä¼˜ç­‰è½¯ä»¶å±‚é¢çš„è°ƒä¼˜

#### 2.æŸ¥çœ‹ç³»ç»Ÿçš„æ€§èƒ½å‚æ•°

å¯ä»¥ä½¿ç”¨show statusè¯­å¥æŸ¥è¯¢ä¸€äº›æ•°æ®åº“æœåŠ¡å™¨çš„**æ€§èƒ½å‚æ•°å’Œä½¿ç”¨é¢‘ç‡**ã€‚

ä¸€äº›å¸¸ç”¨çš„æ€§èƒ½å‚æ•°å¦‚ä¸‹ï¼š

â€¢Connectionsï¼šè¿æ¥MySQLæœåŠ¡å™¨çš„æ¬¡æ•°ã€‚
â€¢Uptimeï¼šMySQLæœåŠ¡å™¨çš„ä¸Šçº¿æ—¶é—´ã€‚
â€¢Slow_queriesï¼šæ…¢æŸ¥è¯¢çš„æ¬¡æ•°ã€‚
â€¢Innodb_rows_readï¼šSelectæŸ¥è¯¢è¿”å›çš„è¡Œæ•°
â€¢Innodb_rows_insertedï¼šæ‰§è¡ŒINSERTæ“ä½œæ’å…¥çš„è¡Œæ•°
â€¢Innodb_rows_updatedï¼šæ‰§è¡ŒUPDATEæ“ä½œæ›´æ–°çš„è¡Œæ•°
â€¢Innodb_rows_deletedï¼šæ‰§è¡ŒDELETEæ“ä½œåˆ é™¤çš„è¡Œæ•°
â€¢Com_selectï¼šæŸ¥è¯¢æ“ä½œçš„æ¬¡æ•°ã€‚
â€¢Com_insertï¼šæ’å…¥æ“ä½œçš„æ¬¡æ•°ã€‚å¯¹äºæ‰¹é‡æ’å…¥çš„ INSERT æ“ä½œï¼Œåªç´¯åŠ ä¸€æ¬¡ã€‚
â€¢Com_updateï¼šæ›´æ–°æ“ä½œçš„æ¬¡æ•°ã€‚
â€¢Com_deleteï¼šåˆ é™¤æ“ä½œçš„æ¬¡æ•°

- è‹¥æŸ¥è¯¢MySQLæœåŠ¡å™¨çš„è¿æ¥æ¬¡æ•°ï¼Œåˆ™å¯ä»¥æ‰§è¡Œå¦‚ä¸‹è¯­å¥ï¼š

  ```mysql
  mysql> show status like 'connections';
  +---------------+-------+
  | Variable_name | Value |
  +---------------+-------+
  | Connections   | 8     |
  +---------------+-------+
  1 row in set (0.02 sec)
  ```

- è‹¥æŸ¥è¯¢æœåŠ¡å™¨å·¥ä½œæ—¶é—´ï¼Œåˆ™å¯ä»¥æ‰§è¡Œå¦‚ä¸‹è¯­å¥ï¼š

  ```mysql
  mysql> show status like 'uptime';
  +---------------+-------+
  | Variable_name | Value |
  +---------------+-------+
  | Uptime        | 3901  |
  +---------------+-------+
  1 row in set (0.00 sec)
  ```

- è‹¥æŸ¥è¯¢MySQLæœåŠ¡å™¨çš„æ…¢æŸ¥è¯¢æ¬¡æ•°ï¼Œåˆ™å¯ä»¥æ‰§è¡Œå¦‚ä¸‹è¯­å¥ï¼š

  ```mysql
  mysql> SHOW STATUS LIKE 'Slow_queries';
  +---------------+-------+
  | Variable_name | Value |
  +---------------+-------+
  | Slow_queries  | 0     |
  +---------------+-------+
  1 row in set (0.00 sec)
  ```

  æ³¨ï¼šæ…¢æŸ¥è¯¢æ¬¡æ•°å‚æ•°å¯ä»¥ç»“åˆæ…¢æŸ¥è¯¢æ—¥å¿—æ‰¾å‡ºæ…¢æŸ¥è¯¢è¯­å¥ï¼Œç„¶åé’ˆå¯¹æ…¢æŸ¥è¯¢è¯­å¥è¿›è¡Œ `è¡¨ç»“æ„ä¼˜åŒ–` æˆ–è€…`æŸ¥è¯¢è¯­å¥ä¼˜åŒ–`

- æŸ¥çœ‹å­˜å‚¨å¼•æ“å¢åˆ æ”¹æŸ¥çš„è¡Œæ•°ï¼Œåˆ™å¯ä»¥æ‰§è¡Œå¦‚ä¸‹è¯­å¥ï¼š

  ```mysql
  mysql> show status like 'innodb_rows_%';
  +----------------------+----------+
  | Variable_name        | Value    |
  +----------------------+----------+
  | Innodb_rows_deleted  | 0        |
  | Innodb_rows_inserted | 1000902  |
  | Innodb_rows_read     | 37011100 |
  | Innodb_rows_updated  | 0        |
  +----------------------+----------+
  4 rows in set (0.00 sec)
  ```

  

#### **3.** **ç»Ÿè®¡SQLçš„æŸ¥è¯¢æˆæœ¬ï¼šlast_query_cost**

![a4241b17ff5659823e4c5ce6e8adf251](./%E7%AC%AC09%E7%AB%A0%20%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8.assets/a4241b17ff5659823e4c5ce6e8adf251.png)

```mysql
SHOW STATUS LIKE 'last_query_cost';
```

```mysql
mysql> select * from student_info where id=900001;
+--------+------------+--------+-----------+----------+---------------------+
| id     | student_id | name   | course_id | class_id | create_time         |
+--------+------------+--------+-----------+----------+---------------------+
| 900001 |      32727 | UXgOBo |     10068 |    10129 | 2024-04-01 18:35:17 |
+--------+------------+--------+-----------+----------+---------------------+
1 row in set (0.00 sec)

mysql> show status like 'last_query_cost';
+-----------------+----------+
| Variable_name   | Value    |
+-----------------+----------+
| Last_query_cost | 1.000000 |  #è¿™é‡Œçš„1ä»£è¡¨é¡µæ•°
+-----------------+----------+
1 row in set (0.00 sec)

mysql> select * from student_info where student_id=199900;
+--------+------------+--------+-----------+----------+---------------------+
| id     | student_id | name   | course_id | class_id | create_time         |
+--------+------------+--------+-----------+----------+---------------------+
| 350159 |     199900 | ZWKJrJ |     10034 |    10000 | 2024-04-01 18:34:59 |
| 631168 |     199900 | mjlDhb |     10087 |    10184 | 2024-04-01 18:35:08 |
| 656281 |     199900 | zxPFJD |     10039 |    10167 | 2024-04-01 18:35:09 |
| 685395 |     199900 | AEvneI |     10049 |    10099 | 2024-04-01 18:35:10 |
+--------+------------+--------+-----------+----------+---------------------+
4 rows in set (0.23 sec)

mysql> show status like 'last_query_cost';
+-----------------+---------------+
| Variable_name   | Value         |
+-----------------+---------------+
| Last_query_cost | 100512.649000 |
+-----------------+---------------+
1 row in set (0.00 sec)

mysql> select * from student_info where student_id=199000;
+--------+------------+--------+-----------+----------+---------------------+
| id     | student_id | name   | course_id | class_id | create_time         |
+--------+------------+--------+-----------+----------+---------------------+
| 164483 |     199000 | evQROr |     10072 |    10127 | 2024-04-01 18:34:53 |
| 365712 |     199000 | HntgwQ |     10018 |    10021 | 2024-04-01 18:34:59 |
| 529283 |     199000 | ZWJImj |     10067 |    10200 | 2024-04-01 18:35:05 |
| 592403 |     199000 | sQaDRw |     10090 |    10108 | 2024-04-01 18:35:07 |
| 681580 |     199000 | wkKSlB |     10041 |    10170 | 2024-04-01 18:35:10 |
+--------+------------+--------+-----------+----------+---------------------+
5 rows in set (0.20 sec)

```

ä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰å‘ç°ï¼Œä¸Šé¢çš„æŸ¥è¯¢é¡µçš„æ•°é‡æ˜¯åˆšæ‰çš„ 10å€ï¼Œä½†æ˜¯æŸ¥è¯¢çš„æ•ˆç‡å¹¶æ²¡æœ‰æ˜æ˜¾çš„å˜åŒ–ï¼Œå°±æ˜¯å› ä¸ºé‡‡ç”¨äº†**é¡ºåºè¯»å–**çš„æ–¹å¼å°†é¡µé¢ä¸€æ¬¡æ€§åŠ è½½åˆ°ç¼“å†²æ± ä¸­ï¼Œç„¶åå†è¿›è¡ŒæŸ¥æ‰¾ã€‚è™½ç„¶é¡µæ•°é‡ï¼ˆ`last_query_cost`ï¼‰å¢åŠ äº†ä¸å°‘ï¼Œä½†æ˜¯é€šè¿‡ç¼“å†²æ± çš„æœºåˆ¶ï¼Œå¹¶æ²¡æœ‰å¢åŠ å¤šå°‘æŸ¥è¯¢æ—¶é—´ã€‚

ä½¿ç”¨åœºæ™¯ï¼šå®ƒå¯¹äºæ¯”è¾ƒå¼€é”€æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œç‰¹åˆ«æ˜¯æˆ‘ä»¬æœ‰å¥½å‡ ç§æŸ¥è¯¢æ–¹å¼å¯é€‰çš„æ—¶å€™ã€‚

> SQL æŸ¥è¯¢æ˜¯ä¸€ä¸ªåŠ¨æ€çš„è¿‡ç¨‹ï¼Œä»é¡µåŠ è½½çš„è§’åº¦æ¥çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä»¥ä¸‹ä¸¤ç‚¹ç»“è®ºï¼š
>
> 1. `ä½ç½®å†³å®šæ•ˆç‡`ã€‚å¦‚æœé¡µå°±åœ¨æ•°æ®åº“`ç¼“å†²æ± `ä¸­ï¼Œé‚£ä¹ˆæ•ˆç‡æ˜¯æœ€é«˜çš„ï¼Œå¦åˆ™è¿˜éœ€è¦ä»`å†…å­˜`æˆ–è€…`ç£ç›˜`ä¸­è¿›è¡Œè¯»å–ï¼Œå½“ç„¶é’ˆå¯¹å•ä¸ªé¡µçš„è¯»å–æ¥è¯´ï¼Œå¦‚æœé¡µå­˜åœ¨äºå†…å­˜ä¸­ï¼Œä¼šæ¯”åœ¨ç£ç›˜ä¸­è¯»å–æ•ˆç‡é«˜å¾ˆå¤šã€‚==å³ æ•°æ®åº“ç¼“å†²æ± >å†…å­˜>ç£ç›˜==
> 2. `æ‰¹é‡å†³å®šæ•ˆç‡`ã€‚å¦‚æœæˆ‘ä»¬ä»ç£ç›˜ä¸­å¯¹å•ä¸€é¡µè¿›è¡Œéšæœºè¯»ï¼Œé‚£ä¹ˆæ•ˆç‡æ˜¯å¾ˆä½çš„ï¼ˆå·®ä¸å¤š10msï¼‰ï¼Œè€Œé‡‡ç”¨é¡ºåºè¯»å–çš„æ–¹å¼ï¼Œæ‰¹é‡å¯¹é¡µè¿›è¡Œè¯»å–ï¼Œå¹³å‡ä¸€é¡µçš„è¯»å–æ•ˆç‡å°±ä¼šæå‡å¾ˆå¤šï¼Œç”šè‡³è¦å¿«äºå•ä¸ªé¡µé¢åœ¨å†…å­˜ä¸­çš„éšæœºè¯»å–ã€‚==å³é¡ºåºè¯»å–>å¤§äºéšæœºè¯»å–==
>
> æ‰€ä»¥è¯´ï¼Œé‡åˆ°I/Oå¹¶ä¸ç”¨æ‹…å¿ƒï¼Œæ–¹æ³•æ‰¾å¯¹äº†ï¼Œæ•ˆç‡è¿˜æ˜¯å¾ˆé«˜çš„ã€‚æˆ‘ä»¬é¦–å…ˆè¦è€ƒè™‘æ•°æ®å­˜æ”¾çš„ä½ç½®ï¼Œå¦‚æœæ˜¯ç»å¸¸ä½¿ç”¨çš„æ•°æ®å°±è¦å°½é‡æ”¾åˆ°`ç¼“å†²æ± `ä¸­ï¼Œå…¶æ¬¡æˆ‘ä»¬å¯ä»¥å……åˆ†åˆ©ç”¨ç£ç›˜çš„ååèƒ½åŠ›ï¼Œä¸€æ¬¡æ€§æ‰¹é‡è¯»å–æ•°æ®ï¼Œè¿™æ ·å•ä¸ªé¡µçš„è¯»å–æ•ˆç‡ä¹Ÿå°±å¾—åˆ°äº†æå‡ã€‚



#### **4.** **å®šä½æ‰§è¡Œæ…¢çš„SQLï¼šæ…¢æŸ¥è¯¢æ—¥å¿—**(==æ²¡å¬æ˜ç™½==)

MySQLçš„æ…¢æŸ¥è¯¢æ—¥å¿—ï¼Œç”¨æ¥è®°å½•åœ¨MySQLä¸­`å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼`çš„è¯­å¥ï¼Œå…·ä½“æŒ‡è¿è¡Œæ—¶é—´è¶…è¿‡`long_query_time`çš„å€¼çš„SQLï¼Œåˆ™ä¼šè¢«è®°å½•åˆ°æ…¢æŸ¥è¯¢æ—¥å¿—ä¸­ã€‚long_query_timeçš„é»˜è®¤å€¼ä¸º`10`ï¼Œæ„æ€æ˜¯è¿è¡Œ10ç§’ä»¥ä¸Šï¼ˆä¸å«10ç§’ï¼‰çš„è¯­å¥ï¼Œè®¤ä¸ºæ˜¯è¶…å‡ºäº†æˆ‘ä»¬çš„æœ€å¤§å¿è€æ—¶é—´å€¼ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒMySQLæ•°æ®åº“`æ²¡æœ‰å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—`ï¼Œéœ€è¦æˆ‘ä»¬æ‰‹åŠ¨æ¥è®¾ç½®è¿™ä¸ªå‚æ•°ã€‚`å¦‚æœä¸æ˜¯è°ƒä¼˜éœ€è¦çš„è¯ï¼Œä¸€èˆ¬ä¸å»ºè®®å¯åŠ¨è¯¥å‚æ•°`ï¼Œå› ä¸ºå¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—ä¼šæˆ–å¤šæˆ–å°‘å¸¦æ¥ä¸€å®šçš„æ€§èƒ½å½±å“ã€‚

##### **4.1** **å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—å‚æ•°**

**1.** **å¼€å¯slow_query_log**

```mysql
set global slow_query_log='ON';
```

æŸ¥çœ‹ä¸‹æ…¢æŸ¥è¯¢æ—¥å¿—æ˜¯å¦å¼€å¯ï¼Œä»¥åŠæ…¢æŸ¥è¯¢æ—¥å¿—æ–‡ä»¶çš„ä½ç½®ï¼š

```mysql
show variables like `%slow_query_log%`;
```

**2.** **ä¿®æ”¹long_query_timeé˜ˆå€¼**

```mysql
show variables like '%long_query_time%';
```

```mysql
#æµ‹è¯•å‘ç°ï¼šè®¾ç½®globalçš„æ–¹å¼å¯¹å½“å‰sessionçš„long_query_timeå¤±æ•ˆã€‚å¯¹æ–°è¿æ¥çš„å®¢æˆ·ç«¯æœ‰æ•ˆã€‚æ‰€ä»¥å¯ä»¥ä¸€å¹¶ æ‰§è¡Œä¸‹è¿°è¯­å¥ 
mysql > set global long_query_time = 1; 
mysql> show global variables like '%long_query_time%'; 

mysql> set long_query_time=1; 
mysql> show variables like '%long_query_time%';
```

![51771021b4ad2f3850697f73979f7176](./%E7%AC%AC09%E7%AB%A0%20%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8.assets/51771021b4ad2f3850697f73979f7176.png)

##### **4.2** **æŸ¥çœ‹æ…¢æŸ¥è¯¢æ•°ç›®**

```mysql
SHOW GLOBAL STATUS LIKE '%Slow_queries%';
```

##### 4.3 æ¡ˆä¾‹æ¼”ç¤º

åˆ›å»ºè¡¨

```mysql
CREATE TABLE `student` (
    `id` INT(11) NOT NULL AUTO_INCREMENT,
    `stuno` INT NOT NULL ,
    `name` VARCHAR(20) DEFAULT NULL,
    `age` INT(3) DEFAULT NULL,
    `classId` INT(11) DEFAULT NULL,
    PRIMARY KEY (`id`)
) ENGINE=INNODB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;

```

åˆ›å»ºå‡½æ•°

```mysql
set global log_bin_trust_function_creators=1;   # ä¸åŠ globalåªæ˜¯å½“å‰çª—å£æœ‰æ•ˆ

DELIMITER //
CREATE FUNCTION rand_string(n INT)
RETURNS VARCHAR(255) #è¯¥å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²
BEGIN
DECLARE chars_str VARCHAR(100) DEFAULT
'abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ';
DECLARE return_str VARCHAR(255) DEFAULT '';
DECLARE i INT DEFAULT 0;
WHILE i < n DO
   SET return_str =CONCAT(return_str,SUBSTRING(chars_str,FLOOR(1+RAND()*52),1));
   SET i = i + 1;
  END WHILE;
  RETURN return_str;
END //
DELIMITER ;
#æµ‹è¯•
SELECT rand_string(10);

```

äº§ç”Ÿéšæœºæ•°å€¼

```mysql
DELIMITER //
CREATE FUNCTION rand_num (from_num INT ,to_num INT) RETURNS INT(11)
BEGIN 
DECLARE i INT DEFAULT 0; 
SET i = FLOOR(from_num +RAND()*(to_num - from_num+1))  ;
RETURN i; 
END //
DELIMITER ;
#æµ‹è¯•ï¼š
SELECT rand_num(10,100);

```

åˆ›å»ºå­˜å‚¨è¿‡ç¨‹

```mysql
DELIMITER //
CREATE PROCEDURE insert_stu1(  START INT , max_num INT )
BEGIN 
DECLARE i INT DEFAULT 0; 
SET autocommit = 0;   #è®¾ç½®æ‰‹åŠ¨æäº¤äº‹åŠ¡
REPEAT  #å¾ªç¯
SET i = i + 1;  #èµ‹å€¼
INSERT INTO student (stuno, NAME ,age ,classId ) VALUES
((START+i),rand_string(6),rand_num(10,100),rand_num(10,1000)); 
UNTIL i = max_num 
END REPEAT; 
COMMIT;  #æäº¤äº‹åŠ¡
END //
DELIMITER ;
```

è°ƒç”¨å­˜å‚¨è¿‡ç¨‹

```mysql
#è°ƒç”¨åˆšåˆšå†™å¥½çš„å‡½æ•°, 4000000æ¡è®°å½•,ä»100001å·å¼€å§‹
mysql> CALL insert_stu1(100001,4000000);

```

æ³¨æ„ï¼Œè¿™ä¸ªæ—¶é—´ä¼šæ¯”è¾ƒé•¿ï¼Œè¯·è€å¿ƒç­‰å¾…å‡ åˆ†é’Ÿå“Ÿã€‚ç»“æŸåå¯ä»¥æŸ¥è¯¢ä¸‹æ˜¯ä¸æ˜¯æ’å…¥æˆåŠŸäº†ã€‚

```mysql
mysql> select count(*) from student;
+----------+
| count(*) |
+----------+
|  4000000 |
+----------+
1 row in set (0.82 sec)

```

##### 4.4 æµ‹è¯•åŠè¯´æ˜

**1. æ‰§è¡Œä¸€ä¸‹ä¸‹é¢çš„æŸ¥è¯¢æ“ä½œï¼Œè¿›è¡Œæ…¢æŸ¥è¯¢è¯­å¥çš„æµ‹è¯•**

```mysql
# æ³¨æ„ï¼šæ­¤æ—¶long_query_timeå·²ç»è®¾ç½®ä¸º1äº†å“¦~
mysql> SELECT * FROM student WHERE stuno = 3455655;
+---------+---------+--------+------+---------+
| id      | stuno   | name   | age  | classId |
+---------+---------+--------+------+---------+
| 3355654 | 3455655 | ZfCwDz |   76 |     228 |
+---------+---------+--------+------+---------+
1 row in set (1.03 sec)

mysql> SELECT * FROM student WHERE name = 'ZfCwDz';
+---------+---------+--------+------+---------+
| id      | stuno   | name   | age  | classId |
+---------+---------+--------+------+---------+
|   32843 |  132844 | zfcWDZ |   32 |     304 |
|  889126 |  989127 | ZfCwDz |   77 |     249 |
| 2015535 | 2115536 | zfcWDZ |   36 |     459 |
| 3176527 | 3276528 | ZFcwdZ |   81 |     941 |
| 3355654 | 3455655 | ZfCwDz |   76 |     228 |
+---------+---------+--------+------+---------+
5 rows in set (1.09 sec)

```

ä»ä¸Šé¢çš„ç»“æœå¯ä»¥çœ‹å‡ºæ¥ï¼ŒæŸ¥è¯¢å­¦ç”Ÿç¼–å·åˆå’Œå§“åèŠ±è´¹æ—¶é—´ éƒ½åœ¨1sä»¥ä¸Šã€‚å·²ç»è¾¾åˆ°äº†ç§’çš„æ•°é‡çº§ï¼Œè¯´æ˜ç›®å‰æŸ¥è¯¢æ•ˆç‡æ˜¯éå¸¸ä½çš„ï¼Œä¸‹é¢æˆ‘ä»¬åˆ†æä¸€ä¸‹åŸå› :

**2. å…ˆæŸ¥çœ‹ä¸‹æ…¢æŸ¥è¯¢çš„è®°å½•**

```mysql
mysql> show status like 'slow_queries';
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| Slow_queries  | 2     |
+---------------+-------+
1 row in set (0.01 sec)

```

> ğŸ¯è¡¥å……è¯´æ˜ï¼š
>
> åœ¨Mysqlä¸­ï¼Œé™¤äº†ä¸Šè¿°å˜é‡ï¼Œæ§åˆ¶æ…¢æŸ¥è¯¢æ—¥å¿—çš„è¿˜æœ‰å¦å¤–ä¸€ä¸ªå˜é‡ min_examined_row_limit ã€‚è¿™ä¸ªå˜é‡çš„æ„æ€æ˜¯ï¼ŒæŸ¥è¯¢æ‰«æè¿‡çš„æœ€å°‘è®°å½•æ•°ã€‚è¿™ä¸ªå˜é‡å’ŒæŸ¥è¯¢æ‰§è¡Œæ—¶é—´ï¼Œå…±åŒç»„æˆäº†åˆ¤åˆ«ä¸€ä¸ªæŸ¥è¯¢æ˜¯å¦æ…¢æŸ¥è¯¢çš„æ¡ä»¶ã€‚å¦‚æœæŸ¥è¯¢æ‰«æè¿‡çš„è®°å½•æ•°å¤§äºç­‰äºè¿™ä¸ªå˜é‡çš„å€¼ï¼Œå¹¶ä¸”æŸ¥è¯¢æ‰§è¡Œæ—¶é—´è¶…è¿‡ long_query_time çš„å€¼ï¼Œé‚£ä¹ˆè¿™ä¸ªæŸ¥è¯¢å°±è¢«è®°å½•åˆ°æ…¢æŸ¥è¯¢æ—¥å¿—ä¸­ã€‚åä¹‹ï¼Œåˆ™ä¸è¢«è®°å½•åˆ°æ…¢æŸ¥è¯¢æ—¥å¿—ä¸­ã€‚å¦å¤–ï¼Œmin_examined_row_limit é»˜è®¤æ˜¯ 0ï¼Œæˆ‘ä»¬ä¹Ÿä¸€èˆ¬ä¸ä¼šå»ä¿®æ”¹å®ƒã€‚
>
>     mysql> SHOW VARIABLES like 'min%';
>     +------------------------+-------+
>     | Variable_name          | Value |
>     +------------------------+-------+
>     | min_examined_row_limit | 0     |
>     +------------------------+-------+
>     1 row in set (0.02 sec)
>
> å½“è¿™ä¸ªå€¼ä¸ºé»˜è®¤å€¼0æ—¶ï¼Œä¸ long_query_time=10åˆåœ¨ä¸€èµ·ï¼Œè¡¨ç¤ºåªè¦æŸ¥è¯¢çš„æ‰§è¡Œæ—¶é—´è¶…è¿‡10ç§’é’Ÿï¼Œå“ªæ€•ä¸€ä¸ªè®°å½•ä¹Ÿæ²¡æœ‰æ‰«æè¿‡ï¼Œéƒ½è¦è¢«è®°å½•åˆ°æ…¢æŸ¥è¯¢æ—¥å¿—ä¸­ã€‚ä½ ä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦ï¼Œé€šè¿‡ä¿®æ”¹"my.ini"æ–‡ä»¶ï¼Œæ¥ä¿®æ”¹æŸ¥è¯¢æ—¶é•¿ï¼Œæˆ–è€…é€šè¿‡SETæŒ‡ä»¤ï¼Œç”¨SQLè¯­å¥ä¿®æ”¹min_examined_row_limit çš„å€¼ã€‚
> 
>



##### **4.3**5 **æ…¢æŸ¥è¯¢æ—¥å¿—åˆ†æå·¥å…·ï¼šmysqldumpslow**

```shell
#å¾—åˆ°è¿”å›è®°å½•é›†æœ€å¤šçš„10ä¸ªSQL 
mysqldumpslow -s r -t 10 /var/lib/mysql/atguigu-slow.log 
#å¾—åˆ°è®¿é—®æ¬¡æ•°æœ€å¤šçš„10ä¸ªSQL 
mysqldumpslow -s c -t 10 /var/lib/mysql/atguigu-slow.log
#å¾—åˆ°æŒ‰ç…§æ—¶é—´æ’åºçš„å‰10æ¡é‡Œé¢å«æœ‰å·¦è¿æ¥çš„æŸ¥è¯¢è¯­å¥ 
mysqldumpslow -s t -t 10 -g "left join" /var/lib/mysql/atguigu-slow.log 
#å¦å¤–å»ºè®®åœ¨ä½¿ç”¨è¿™äº›å‘½ä»¤æ—¶ç»“åˆ | å’Œmore ä½¿ç”¨ ï¼Œå¦åˆ™æœ‰å¯èƒ½å‡ºç°çˆ†å±æƒ…å†µ 
mysqldumpslow -s r -t 10 /var/lib/mysql/atguigu-slow.log | more
```

![ff77e4fe5a137f3e0e984dfed2d24a10](./%E7%AC%AC09%E7%AB%A0%20%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8.assets/ff77e4fe5a137f3e0e984dfed2d24a10.png)

mysqldumpslow å‘½ä»¤çš„å…·ä½“å‚æ•°å¦‚ä¸‹ï¼š

    -a: ä¸å°†æ•°å­—æŠ½è±¡æˆNï¼Œå­—ç¬¦ä¸²æŠ½è±¡æˆS
    -s: æ˜¯è¡¨ç¤ºæŒ‰ç…§ä½•ç§æ–¹å¼æ’åºï¼š
        c: è®¿é—®æ¬¡æ•°
        l: é”å®šæ—¶é—´
        r: è¿”å›è®°å½•
        t: æŸ¥è¯¢æ—¶é—´
        al:å¹³å‡é”å®šæ—¶é—´
        ar:å¹³å‡è¿”å›è®°å½•æ•°
        at:å¹³å‡æŸ¥è¯¢æ—¶é—´ ï¼ˆé»˜è®¤æ–¹å¼ï¼‰
        ac:å¹³å‡æŸ¥è¯¢æ¬¡æ•°
    -t: å³ä¸ºè¿”å›å‰é¢å¤šå°‘æ¡çš„æ•°æ®ï¼›
    -g: åè¾¹æ­é…ä¸€ä¸ªæ­£åˆ™åŒ¹é…æ¨¡å¼ï¼Œå¤§å°å†™ä¸æ•æ„Ÿçš„ï¼›
æ¥ä¸‹æ¥æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°æ…¢æŸ¥è¯¢æ—¥å¿—çš„ä½ç½®:

![188dc7f9814dd009bc01d26143986532](./%E7%AC%AC09%E7%AB%A0%20%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8.assets/188dc7f9814dd009bc01d26143986532.png)

ä¸¾ä¾‹ï¼šæˆ‘ä»¬æƒ³è¦æŒ‰ç…§æŸ¥è¯¢æ—¶é—´æ’åºï¼ŒæŸ¥çœ‹å‰äº”æ¡ SQL è¯­å¥ï¼Œè¿™æ ·å†™å³å¯ï¼š

```mysql
[root@hadoop102 mysql]# mysqldumpslow -s t -t 5 /var/lib/mysql/hadoop102-slow.log 

Reading mysql slow query log from /var/lib/mysql/hadoop102-slow.log
Count: 1  Time=283.29s (283s)  Lock=0.00s (0s)  Rows=0.0 (0), root[root]@hadoop102
  CALL insert_stu1(N,N)

Count: 1  Time=1.09s (1s)  Lock=0.00s (0s)  Rows=5.0 (5), root[root]@localhost
  SELECT * FROM student WHERE name = 'S'

Count: 1  Time=1.03s (1s)  Lock=0.00s (0s)  Rows=1.0 (1), root[root]@localhost
  SELECT * FROM student WHERE stuno = N

Died at /usr/bin/mysqldumpslow line 162, <> chunk 3.

```

##### **4.5** **å…³é—­æ…¢æŸ¥è¯¢æ—¥å¿—**

**æ–¹å¼1ï¼šæ°¸ä¹…æ€§æ–¹å¼**

```ini
[mysqld] 
slow_query_log=OFF
#æˆ–
[mysqld] 
#slow_query_log =OFF
```

**æ–¹å¼2ï¼šä¸´æ—¶æ€§æ–¹å¼**

```mysql
SET GLOBAL slow_query_log=off;
```

##### 4.6 åˆ é™¤ä¸æ¢å¤æ…¢æŸ¥è¯¢æ—¥å¿—

è°ƒä¼˜ç»“æŸå¯ä»¥åŠæ—¶åˆ é™¤æ…¢æŸ¥è¯¢æ—¥å¿—èŠ‚çœç£ç›˜ç©ºé—´å“Ÿï¼Œå½“ç„¶æ‰‹å·¥åˆ é™¤ä¹Ÿæ˜¯å¯ä»¥çš„

![0e43bfc76b2ffd873a3e881e7c8fac6f](./%E7%AC%AC09%E7%AB%A0%20%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8.assets/0e43bfc76b2ffd873a3e881e7c8fac6f.png)

å¦‚æœè¯¯åˆ äº†ï¼Œè€Œä¸”è¿˜æ²¡æœ‰äº†å¤‡ä»½ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥é‡æ–°æ¢å¤ç”Ÿæˆå“Ÿï¼Œæ‰§è¡Œå®Œæ¯•åä¼šåœ¨æ•°æ®ç›®å½•ä¸‹é‡æ–°ç”ŸæˆæŸ¥è¯¢æ—¥å¿—æ–‡ä»¶

```mysql
#å…ˆè¦æ‰“å¼€æ…¢æŸ¥è¯¢æ—¥å¿—
SET GLOBAL slow_query_log=ON;
#æ¢å¤æ…¢æŸ¥è¯¢æ—¥å¿—
mysqladmin -uroot -p flush-logs slow
```

>æç¤º

> æ…¢æŸ¥è¯¢æ—¥å¿—éƒ½æ˜¯ä½¿ç”¨`mysqladmin -uroot -p flush-logs slow` å‘½ä»¤æ¥åˆ é™¤é‡å»ºçš„ã€‚ä½¿ç”¨æ—¶ä¸€å®šè¦æ³¨æ„ï¼Œä¸€æ—¦æ‰§è¡Œäº†è¿™ä¸ªå‘½ä»¤ï¼Œæ…¢æŸ¥è¯¢æ—¥å¿—éƒ½åªå­˜åœ¨äºæ–°çš„æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œå¦‚æœéœ€è¦æ—§çš„æŸ¥è¯¢æ—¥å¿—ï¼Œå°±å¿…é¡»äº‹å…ˆå¤‡ä»½ã€‚









#### **5.** **æŸ¥çœ‹** **SQL** **æ‰§è¡Œæˆæœ¬ï¼šSHOW PROFILE**

```mysql
show variables like 'profiling';
#å¼€å¯
set profiling = 'ON';
#æŸ¥çœ‹
show profiles;
show profile cpu,block io for query 2;
```

ğŸ”Š show profileçš„å¸¸ç”¨æŸ¥è¯¢å‚æ•°ï¼š

â‘  ALLï¼šæ˜¾ç¤ºæ‰€æœ‰çš„å¼€é”€ä¿¡æ¯ã€‚
â‘¡ BLOCK IOï¼šæ˜¾ç¤ºå— IO å¼€é”€ã€‚
â‘¢ CONTEXT SWITCHESï¼šä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ã€‚
â‘£ CPUï¼šæ˜¾ç¤º CPU å¼€é”€ä¿¡æ¯ã€‚
â‘¤ IPCï¼šæ˜¾ç¤ºå‘é€å’Œæ¥æ”¶å¼€é”€ä¿¡æ¯ã€‚
â‘¥ MEMORYï¼šæ˜¾ç¤ºå†…å­˜å¼€é”€ä¿¡æ¯ã€‚
â‘¦ PAGE FAULTSï¼šæ˜¾ç¤ºé¡µé¢é”™è¯¯å¼€é”€ä¿¡æ¯ã€‚
â‘§ SOURCEï¼šæ˜¾ç¤ºå’Œ Source_functionï¼ŒSource_fileï¼ŒSource_line ç›¸å…³çš„å¼€é”€ä¿¡æ¯ã€‚
â‘¨ SWAPSï¼šæ˜¾ç¤ºäº¤æ¢æ¬¡æ•°å¼€é”€ä¿¡æ¯ã€‚

> `SHOW PROFILE` å‘½ä»¤å°†è¢«å¼ƒç”¨ï¼Œä¸è¿‡æˆ‘ä»¬å¯ä»¥ä» `information_schema` ä¸­çš„ `profiling` æ•°æ®è¡¨è¿›è¡ŒæŸ¥çœ‹



#### **6.** **åˆ†ææŸ¥è¯¢è¯­å¥ï¼šEXPLAIN**ï¼ˆå†…å®¹å¤ªå¤šäº†ï¼Œæˆ‘æ²¡ä»”ç»†çœ‹ï¼‰

![0f20ee3121dfd0daee25ee3ba1db8b43](./%E7%AC%AC09%E7%AB%A0%20%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8.assets/0f20ee3121dfd0daee25ee3ba1db8b43.png)



##### **6.1** **åŸºæœ¬è¯­æ³•**

```mysql
EXPLAIN SELECT select_options 
#æˆ–è€…
DESCRIBE SELECT select_options
```

å¦‚æœæˆ‘ä»¬æƒ³çœ‹çœ‹æŸä¸ªæŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’çš„è¯ï¼Œå¯ä»¥åœ¨å…·ä½“çš„æŸ¥è¯¢è¯­å¥å‰è¾¹åŠ ä¸€ä¸ªEXPLAIN ï¼Œå°±åƒè¿™æ ·ï¼š

```mysql
mysql> EXPLAIN SELECT 1;
```

![9a5762c760918391af90e5a10af5c529](./%E7%AC%AC09%E7%AB%A0%20%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8.assets/9a5762c760918391af90e5a10af5c529.png)

![7e286d10ad9a06464f4911aa5505bb79](./%E7%AC%AC09%E7%AB%A0%20%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8.assets/7e286d10ad9a06464f4911aa5505bb79.png)

**EXPLAIN è¯­å¥è¾“å‡ºçš„å„ä¸ªåˆ—çš„ä½œç”¨å¦‚ä¸‹ï¼š**

| åˆ—å          | æè¿°                                                     |
| ------------- | -------------------------------------------------------- |
| id            | åœ¨ä¸€ä¸ªå¤§çš„æŸ¥è¯¢è¯­å¥ä¸­æ¯ä¸ªSELECTå…³é”®å­—éƒ½å¯¹åº”ä¸€ä¸ª`å”¯ä¸€çš„id` |
| select_type   | SELECTå…³é”®å­—å¯¹åº”çš„é‚£ä¸ªæŸ¥è¯¢çš„ç±»å‹                         |
| table         | è¡¨å                                                     |
| partitions    | åŒ¹é…çš„åˆ†åŒºä¿¡æ¯                                           |
| type          | é’ˆå¯¹å•è¡¨çš„è®¿é—®æ–¹æ³•                                       |
| possible_keys | å¯èƒ½ç”¨åˆ°çš„ç´¢å¼•                                           |
| key           | å®é™…ä¸Šä½¿ç”¨çš„ç´¢å¼•                                         |
| key_len       | å®é™…ä½¿ç”¨åˆ°çš„ç´¢å¼•é•¿åº¦                                     |
| ref           | å½“ä½¿ç”¨ç´¢å¼•åˆ—ç­‰å€¼æŸ¥è¯¢æ—¶ï¼Œä¸ç´¢å¼•åˆ—è¿›è¡Œç­‰å€¼åŒ¹é…çš„å¯¹è±¡ä¿¡æ¯   |
| rows          | é¢„ä¼°çš„éœ€è¦è¯»å–çš„è®°å½•æ¡æ•°                                 |
| filtered      | æŸä¸ªè¡¨ç»è¿‡æœç´¢æ¡ä»¶è¿‡æ»¤åå‰©ä½™è®°å½•æ¡æ•°çš„ç™¾åˆ†æ¯”             |
| Extra         | ä¸€äº›é¢å¤–çš„ä¿¡æ¯                                           |

##### **6.2 EXPLAINå„åˆ—ä½œç”¨**

**1. table**

ä¸è®ºæˆ‘ä»¬çš„æŸ¥è¯¢è¯­å¥æœ‰å¤šå¤æ‚ï¼ŒåŒ…å«äº†å¤šå°‘ä¸ªè¡¨ ï¼Œåˆ°æœ€åä¹Ÿæ˜¯éœ€è¦å¯¹æ¯ä¸ªè¡¨è¿›è¡Œ`å•è¡¨è®¿é—®`çš„ï¼Œæ‰€ä»¥MySQLè§„å®š**EXPLAINè¯­å¥è¾“å‡ºçš„æ¯æ¡è®°å½•éƒ½å¯¹åº”ç€æŸä¸ªå•è¡¨çš„è®¿é—®æ–¹æ³•**ï¼Œè¯¥æ¡è®°å½•çš„tableåˆ—ä»£è¡¨ç€è¯¥è¡¨çš„è¡¨åï¼ˆæœ‰æ—¶ä¸æ˜¯çœŸå®çš„è¡¨åå­—ï¼Œå¯èƒ½æ˜¯ç®€ç§°ï¼‰ã€‚

```mysql
#æŸ¥è¯¢çš„æ¯ä¸€è¡Œè®°å½•éƒ½å¯¹åº”ç€ä¸€ä¸ªå•è¡¨
EXPLAIN SELECT * FROM s1;

# s1ï¼šé©±åŠ¨è¡¨ s2:è¢«é©±åŠ¨è¡¨
EXPLAIN SELECT * FROM s1 INNER JOIN s2;
```

å¦‚ä¸‹å›¾ï¼Œä¸€å¼ è¡¨å¯¹åº”ä¸€ä¸ªè®°å½•ã€‚

![7422bfdc6cf19b57ded5f4254ee65e35](./%E7%AC%AC09%E7%AB%A0%20%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8.assets/7422bfdc6cf19b57ded5f4254ee65e35.png)

**2. id**

å®é™…ä¸Šï¼Œåœ¨æŸ¥è¯¢è¯­å¥ä¸­æ¯å‡ºç°ä¸€ä¸ªSELECTå…³é”®å­—ï¼ŒMySQLå°±ä¼šä¸ºå®ƒåˆ†é…ä¸€ä¸ªå”¯ä¸€çš„id ï¼Œä»£è¡¨ç€ä¸€æ¬¡æŸ¥è¯¢ã€‚è¿™ä¸ªid å°±æ˜¯ `EXPLAIN`è¯­å¥çš„ç¬¬ä¸€åˆ—ã€‚

- **idå¦‚æœç›¸åŒï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç»„ï¼Œä»ä¸Šå¾€ä¸‹é¡ºåºæ‰§è¡Œ**
- **åœ¨æ‰€æœ‰ç»„ä¸­ï¼Œidå€¼è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆæ‰§è¡Œ**
- **å…³æ³¨ç‚¹ï¼šidå·æ¯ä¸ªå·ç ï¼Œè¡¨ç¤ºä¸€è¶Ÿç‹¬ç«‹çš„æŸ¥è¯¢,ä¸€ä¸ªsqlçš„æŸ¥è¯¢è¶Ÿæ•°è¶Šå°‘è¶Šå¥½**

**3. select_type**

![6399b387426312a0db573048fbc61a69](./%E7%AC%AC09%E7%AB%A0%20%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8.assets/6399b387426312a0db573048fbc61a69.png)

**4. partitions**

==5. typeï¼ˆé‡ç‚¹ï¼‰==

![7c4a44543222a55b2b32b0f6bdbe7e80](./%E7%AC%AC09%E7%AB%A0%20%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8.assets/7c4a44543222a55b2b32b0f6bdbe7e80.png)

**1ï¸âƒ£system**

å½“è¡¨ä¸­åªæœ‰ä¸€æ¡è®°å½•ï¼Œå¹¶ä¸”è¯¥è¡¨ä¸­å­˜å‚¨å¼•æ“ç»Ÿè®¡æ•°æ®æ˜¯ç²¾ç¡®çš„ï¼Œæ¯”å¦‚ MYISAMï¼ŒMemoryï¼Œé‚£ä¹ˆå…¶è®¿é—®æ–¹æ³•å°±æ˜¯`System`ã€‚è¿™ç§æ–¹å¼å‡ ä¹æ˜¯æ€§èƒ½æœ€é«˜çš„ï¼Œå½“ç„¶æˆ‘ä»¬å‡ ä¹ç”¨ä¸ä¸Šã€‚

![5a16dae8a7ed78b4c964cc5e0a090ab1](./%E7%AC%AC09%E7%AB%A0%20%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8.assets/5a16dae8a7ed78b4c964cc5e0a090ab1.png)

ä½†å‡¡æˆ‘ä»¬å†æ’å…¥ä¸€æ¡æ•°æ®ï¼Œå…¶è®¿é—®æ–¹å¼å°±å˜æˆäº†æ€§èƒ½æœ€å·®çš„å…¨è¡¨æ‰«æ `ALL`ã€‚

![62fdaf009f7df3825af794fa7f08e940](./%E7%AC%AC09%E7%AB%A0%20%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8.assets/62fdaf009f7df3825af794fa7f08e940.png)

å¦‚æœå­˜å‚¨å¼•æ“æ˜¯InnoDBï¼Œå³ä½¿åªæœ‰ä¸€æ¡æ•°æ®ï¼Œå…¶è®¿é—®æ–¹å¼ä¹Ÿæ˜¯ALLï¼Œè¿™æ˜¯å› ä¸º InnnoDB è®¿é—®æ•°æ®ä¸æ˜¯ç²¾ç¡®çš„

![7795326f2fbf062b3f780738d090513a](./%E7%AC%AC09%E7%AB%A0%20%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8.assets/7795326f2fbf062b3f780738d090513a.png)

**2ï¸âƒ£Const**

å½“æˆ‘ä»¬æ ¹æ®ä¸»é”®æˆ–è€…å”¯ä¸€çš„äºŒçº§ç´¢å¼•ï¼Œä¸å¸¸æ•°è¿›è¡Œç­‰å€¼åŒ¹é…æ—¶ï¼Œå¯¹å•è¡¨çš„è®¿é—®æ–¹æ³•å°±æ˜¯ `const`ã€‚è¿™ä¸ªè®¿é—®æ–¹å¼çš„æ•ˆç‡ä½äº `system`ï¼Œä½†ä¹Ÿæ˜¯å¾ˆé«˜æ•ˆçš„

æ¯”å¦‚å¯¹ä¸»é”®ä¸å¸¸æ•°åŒ¹é…ï¼Œè¿›è¡Œç­‰å€¼æŸ¥è¯¢

```mysql
EXPLAIN SELECT * FROM s1 WHERE id = 10005;
```

![abd6b80cf9af83f23f96405ba7a508ce](./%E7%AC%AC09%E7%AB%A0%20%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8.assets/abd6b80cf9af83f23f96405ba7a508ce.png)

**3ï¸âƒ£eq_ref**

å†è¿›è¡Œ**è¿æ¥æŸ¥è¯¢**æ—¶ï¼Œå¦‚æœ**è¢«é©±åŠ¨è¡¨**æ˜¯é€šè¿‡ä¸»é”®æˆ–è€…å”¯ä¸€äºŒçº§ç´¢å¼•ç­‰å€¼åŒ¹é…çš„æ–¹å¼è¿›è¡ŒæŸ¥è¯¢çš„ï¼Œé‚£ä¹ˆè¢«é©±åŠ¨è¡¨çš„è®¿é—®æ–¹å¼æ˜¯ `eq_ref`ã€‚è¿™ä¹Ÿæ˜¯ä¸€ç§æ€§èƒ½å¾ˆä¸é”™çš„æ–¹å¼ã€‚

```mysql
EXPLAIN SELECT * FROM s1 INNER JOIN s2 ON s1.id = s2.id;
```

ä¸Šé¢è¿æ¥æŸ¥è¯¢è¯­å¥ï¼Œå¯¹äºé©±åŠ¨è¡¨æ¥è¯´ï¼Œå°±æ˜¯å¯¹s1å…¨è¡¨è¿›è¡Œæ‰«æï¼Œæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„æ•°æ®ï¼Œå› æ­¤å…¶`type`æ˜¯`All`,å¯¹è¢«é©±åŠ¨è¡¨æ¥è¯´ï¼Œç›¸äºç›´æ¥è®¿é—®é©±åŠ¨è¡¨æŸ¥è¯¢åˆ°çš„æ•°æ®è¿›è¡Œç­‰å€¼æŸ¥è¯¢ï¼Œå› æ­¤å…¶è®¿é—®æ–¹å¼æ˜¯`eq_ref`

![463fd44a01a106555515b733dd924b90](./%E7%AC%AC09%E7%AB%A0%20%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8.assets/463fd44a01a106555515b733dd924b90.png)



9ï¸âƒ£index

å½“æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç´¢å¼•è¦†ç›–ï¼Œä½†æ˜¯éœ€è¦æ‰«æçš„å…¨éƒ¨çš„ç´¢å¼•è®°å½•æ—¶ï¼Œè¯¥è¡¨çš„è®¿é—®æ–¹å¼å°±æ˜¯ indexã€‚ç´¢å¼•è¦†ç›–åé¢æ–‡ç« ä»‹ç»ä¼˜åŒ–å™¨æ—¶ä¼šè¯¦ç»†ä»‹ç»ï¼Œä¸ºäº†ä¾¿äºå¤§å®¶ç†è§£ï¼Œå…ˆç®€å•ä»‹ç»å¦‚ä¸‹ã€‚æ¯”å¦‚ä¸‹é¢ sql è¯­å¥ä¸­ï¼Œkey_part2 ï¼Œkey_part2 éƒ½å±äºè”åˆç´¢å¼• idx_key_part(key_part1, key_part2, key_part3) çš„ä¸€éƒ¨åˆ†ï¼Œåœ¨æŸ¥æ‰¾æ•°æ®æ—¶å¯ä»¥ç”¨ä¸Šè¿™ä¸ªè”åˆç´¢å¼•ï¼Œè€Œä¸ç”¨è¿›è¡Œå›è¡¨æ“ä½œï¼Œè¿™ç§æƒ…å†µå³ç´¢å¼•è¦†ç›–

```mysql
EXPLAIN SELECT key_part2 FROM s1 WHERE key_part2 = 'a';
```

![cd850a3f00131c5bf7a465d85ccf6fee](./%E7%AC%AC09%E7%AB%A0%20%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8.assets/cd850a3f00131c5bf7a465d85ccf6fee.png)

å°ç»“ï¼š

**ç»“æœå€¼ä»æœ€å¥½åˆ°æœ€åä¾æ¬¡æ˜¯ï¼š** **system > const > eq_ref > ref** **> fulltext > ref_or_null > index_merge > unique_subquery > index_subquery >** **range > index > ALL** 

==SQLæ€§èƒ½ä¼˜åŒ–çš„ç›®æ ‡ï¼šè‡³å°‘è¦è¾¾åˆ° rangeçº§åˆ«ï¼Œè¦æ±‚æ˜¯refçº§åˆ«ï¼Œæœ€å¥½æ˜¯constsçº§åˆ«ã€‚==ï¼ˆé˜¿é‡Œå·´å·´å¼€å‘æ‰‹å†Œè¦æ±‚ï¼‰

**6. possible_keyså’Œkey**

**7. key_lenï¼ˆé‡ç‚¹ï¼‰**

**key_lençš„é•¿åº¦è®¡ç®—å…¬å¼ï¼š**

```
varchar(10)å˜é•¿å­—æ®µä¸”å…è®¸NULL = 10 * ( character setï¼š utf8=3,gbk=2,latin1=1)+1(NULL)+2(å˜é•¿å­—æ®µ) 

varchar(10)å˜é•¿å­—æ®µä¸”ä¸å…è®¸NULL = 10 * ( character setï¼šutf8=3,gbk=2,latin1=1)+2(å˜é•¿å­—æ®µ)

char(10)å›ºå®šå­—æ®µä¸”å…è®¸NULL = 10 * ( character setï¼šutf8=3,gbk=2,latin1=1)+1(NULL) 

char(10)å›ºå®šå­—æ®µä¸”ä¸å…è®¸NULL = 10 * ( character setï¼šutf8=3,gbk=2,latin1=1)
```

**8. ref** 

å½“ç´¢å¼•åˆ—è¿›è¡Œç­‰å€¼æŸ¥è¯¢æ—¶ï¼Œä¸ç´¢å¼•åˆ—åŒ¹é…çš„å¯¹è±¡ä¿¡æ¯ã€‚

**9. rowsï¼ˆé‡ç‚¹ï¼‰**

é¢„ä¼°çš„éœ€è¦è¯»å–çš„è®°å½•æ¡ç›®æ•°ï¼Œæ¡ç›®æ•°è¶Šå°è¶Šå¥½ã€‚è¿™æ˜¯å› ä¸ºå€¼è¶Šå°ï¼ŒåŠ è½½I/Oçš„é¡µæ•°å°±è¶Šå°‘~

```
EXPLAIN SELECT * FROM s1 WHERE key1 > 'z';
```

![8e6c3310d2274c233a39b5cbcff0faea](./%E7%AC%AC09%E7%AB%A0%20%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7%E7%9A%84%E4%BD%BF%E7%94%A8.assets/8e6c3310d2274c233a39b5cbcff0faea.png)

**10. filtered**



**11. Extra**

é¡¾åæ€ä¹‰ï¼Œ`Extra `åˆ—æ˜¯ç”¨æ¥è¯´æ˜ä¸€äº›é¢å¤–ä¿¡æ¯çš„ï¼ŒåŒ…å«ä¸é€‚åˆåœ¨å…¶ä»–åˆ—ä¸­æ˜¾ç¤ºä½†ååˆ†é‡è¦çš„é¢å¤–ä¿¡æ¯ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™äº›é¢å¤–ä¿¡æ¯æ¥`æ›´å‡†ç¡®çš„ç†è§£MySQLåˆ°åº•å°†å¦‚ä½•æ‰§è¡Œç»™å®šçš„æŸ¥è¯¢è¯­å¥`ã€‚MySQLæä¾›çš„é¢å¤–ä¿¡æ¯æœ‰å¥½å‡ åä¸ªï¼Œæˆ‘ä»¬å°±ä¸ä¸€ä¸€ä»‹ç»äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬åªæŒ‘æ¯”è¾ƒé‡è¦çš„é¢å¤–ä¿¡æ¯ä»‹ç»ç»™å¤§å®¶ã€‚





#### **5. EXPLAINçš„è¿›ä¸€æ­¥ä½¿ç”¨**

##### **5.1 EXPLAINå››ç§è¾“å‡ºæ ¼å¼**

è¿™é‡Œè°ˆè°ˆEXPLAINçš„è¾“å‡ºæ ¼å¼ã€‚EXPLAINå¯ä»¥è¾“å‡ºå››ç§æ ¼å¼ï¼š`ä¼ ç»Ÿæ ¼å¼`ï¼Œ`JSONæ ¼å¼`ï¼Œ`TREEæ ¼å¼`ä»¥åŠ`å¯è§†åŒ–è¾“å‡º`ã€‚ç”¨æˆ·å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©é€‚ç”¨äºè‡ªå·±çš„æ ¼å¼ã€‚

**1.** **ä¼ ç»Ÿæ ¼å¼**

**2. JSONæ ¼å¼** 

JSONæ ¼å¼ï¼šåœ¨EXPLAINå•è¯å’ŒçœŸæ­£çš„æŸ¥è¯¢è¯­å¥ä¸­é—´åŠ ä¸Š`FORMAT=JSON`ã€‚ç”¨äºæŸ¥çœ‹æ‰§è¡Œæˆæœ¬`cost_info`

**3. TREEæ ¼å¼**

TREEæ ¼å¼æ˜¯8.0.16ç‰ˆæœ¬ä¹‹åå¼•å…¥çš„æ–°æ ¼å¼ï¼Œä¸»è¦æ ¹æ®æŸ¥è¯¢çš„`å„ä¸ªéƒ¨åˆ†ä¹‹é—´çš„å…³ç³»`å’Œ`å„éƒ¨åˆ†çš„æ‰§è¡Œé¡ºåº`æ¥æè¿°å¦‚ä½•æŸ¥è¯¢ã€‚

**4.** **å¯è§†åŒ–è¾“å‡º**

å¯è§†åŒ–è¾“å‡ºï¼Œå¯ä»¥é€šè¿‡MySQL Workbenchå¯è§†åŒ–æŸ¥çœ‹MySQLçš„æ‰§è¡Œè®¡åˆ’ã€‚

##### **5.2 SHOW WARNINGSçš„ä½¿ç”¨** 

```mysql
mysql> EXPLAIN SELECT s1.key1, s2.key1 FROM s1 LEFT JOIN s2 ON s1.key1 = s2.key1 WHERE s2.common_field IS NOT NULL;
# æŸ¥çœ‹ä¼˜åŒ–åçš„æ‰§è¡Œè¯­å¥
mysql> SHOW WARNINGS\G
```

#### **6.** **åˆ†æä¼˜åŒ–å™¨æ‰§è¡Œè®¡åˆ’ï¼štrace**

```mysql
# å¼€å¯
SET optimizer_trace="enabled=on",end_markers_in_json=on; 
# è®¾ç½®å¤§å°
set optimizer_trace_max_mem_size=1000000;
# ä½¿ç”¨
select * from student where id < 10;
select * from information_schema.optimizer_trace\G
```

#### **7. MySQLç›‘æ§åˆ†æè§†å›¾-sys schema** 

**7.1 Sys schemaè§†å›¾ä½¿ç”¨åœºæ™¯**

**ç´¢å¼•æƒ…å†µ**

```mysql
#1. æŸ¥è¯¢å†—ä½™ç´¢å¼• 
select * from sys.schema_redundant_indexes; 
#2. æŸ¥è¯¢æœªä½¿ç”¨è¿‡çš„ç´¢å¼• 
select * from sys.schema_unused_indexes; 
#3. æŸ¥è¯¢ç´¢å¼•çš„ä½¿ç”¨æƒ…å†µ 
select index_name,rows_selected,rows_inserted,rows_updated,rows_deleted from sys.schema_index_statistics where table_schema='dbname' ;
```

**è¡¨ç›¸å…³**

```mysql
# 1. æŸ¥è¯¢è¡¨çš„è®¿é—®é‡ 
select table_schema,table_name,sum(io_read_requests+io_write_requests) as io from sys.schema_table_statistics group by table_schema,table_name order by io desc; 
# 2. æŸ¥è¯¢å ç”¨bufferpoolè¾ƒå¤šçš„è¡¨ 
select object_schema,object_name,allocated,data
from sys.innodb_buffer_stats_by_table order by allocated limit 10; 
# 3. æŸ¥çœ‹è¡¨çš„å…¨è¡¨æ‰«ææƒ…å†µ 
select * from sys.statements_with_full_table_scans where db='dbname';
```

**è¯­å¥ç›¸å…³**

```mysql
#1. ç›‘æ§SQLæ‰§è¡Œçš„é¢‘ç‡ 
select db,exec_count,query from sys.statement_analysis order by exec_count desc; 
#2. ç›‘æ§ä½¿ç”¨äº†æ’åºçš„SQL 
select db,exec_count,first_seen,last_seen,query
from sys.statements_with_sorting limit 1; 
#3. ç›‘æ§ä½¿ç”¨äº†ä¸´æ—¶è¡¨æˆ–è€…ç£ç›˜ä¸´æ—¶è¡¨çš„SQL 
select db,exec_count,tmp_tables,tmp_disk_tables,query
from sys.statement_analysis where tmp_tables>0 or tmp_disk_tables >0 order by (tmp_tables+tmp_disk_tables) desc;
```

**IOç›¸å…³**

```mysql
#1. æŸ¥çœ‹æ¶ˆè€—ç£ç›˜IOçš„æ–‡ä»¶ 
select file,avg_read,avg_write,avg_read+avg_write as avg_io
from sys.io_global_by_file_by_bytes order by avg_read limit 10;
```

**Innodb** **ç›¸å…³**

```mysql
#1. è¡Œé”é˜»å¡æƒ…å†µ 
select * from sys.innodb_lock_waits;
```

### 